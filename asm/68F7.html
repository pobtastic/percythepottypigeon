<!DOCTYPE html>
<html>
<head>
<title>Percy the Potty Pigeon: Routine at 68F7</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-wide.css" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-75RERFCHBG"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-75RERFCHBG');
</script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="68B8.html">68B8</a>
</td>
<td class="up">Up: <a href="../maps/all.html#68f7">Map</a></td>
<td class="next">
Next: <a href="693B.html">693B</a>
</td>
</tr>
</table>
<div class="description">68F7: Set Up Next Level</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="653D.html">Initialise_Lives</a> and <a href="68B8.html">Handle_Level_Complete</a>.
</div>
<div class="paragraph">
Prepares the game state for the next level. Increments the current level number, awards an extra life on level 04 loads the worm collection target for the new level from the lookup table, and resets all collected and disabled worm markers in the room attribute data.
</div>
</div>
</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="68f7"></span>
<div class="comments">
<div class="paragraph">
Increment the level counter and check for extra life award.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">SetUp_NextLevel</td>
<td class="address-2"><span id="68f7"></span>68F7</td>
<td class="instruction">LD A,($5FB1)</td>
<td class="comment-1" rowspan="1">Fetch the current level from *<a href="5FB1.html">CurrentLevel</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="68fa"></span>68FA</td>
<td class="instruction">LD HL,$5FB3</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at <a href="5FB3.html">LivesDisplayCharacter</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="68fd"></span>68FD</td>
<td class="instruction">CP $05</td>
<td class="comment-1" rowspan="2">Jump to <a href="68F7.html#6911">SetWorm_Target</a> if the current level is equal to 05 (don't increment past the maximum).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="68ff"></span>68FF</td>
<td class="instruction">JR Z,<a href="68F7.html#6911">SetWorm_Target</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6901"></span>6901</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="2">Increment the level number and write it back to *<a href="5FB1.html">CurrentLevel</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6902"></span>6902</td>
<td class="instruction">LD ($5FB1),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6905"></span>6905</td>
<td class="instruction">CP $04</td>
<td class="comment-1" rowspan="2">Jump to <a href="68F7.html#6911">SetWorm_Target</a> if the new level is not equal to 04.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6907"></span>6907</td>
<td class="instruction">JR NZ,<a href="68F7.html#6911">SetWorm_Target</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="6909"></span>
<div class="comments">
<div class="paragraph">
Award an extra life on level 04.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6909"></span>6909</td>
<td class="instruction">INC (HL)</td>
<td class="comment-1" rowspan="2">Increment the lives display character at *<span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="690a"></span>690A</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="690b"></span>690B</td>
<td class="instruction">LD HL,$50F0</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at 50F0 (screen buffer position for the lives display).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="690e"></span>690E</td>
<td class="instruction">CALL <a href="6581.html">PrintCharacter</a></td>
<td class="comment-1" rowspan="1">Call <a href="69F7.html#6a5f">6A5F</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="6911"></span>
<div class="comments">
<div class="paragraph">
Load the worm collection target for the new level.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">SetWorm_Target</td>
<td class="address-2"><span id="6911"></span>6911</td>
<td class="instruction">LD A,($5FB1)</td>
<td class="comment-1" rowspan="1">Fetch the current level from *<a href="5FB1.html">CurrentLevel</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6914"></span>6914</td>
<td class="instruction">LD B,$00</td>
<td class="comment-1" rowspan="3">Set <span class="register">BC</span> to the level number minus one as a table index.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6916"></span>6916</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6917"></span>6917</td>
<td class="instruction">DEC C</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6918"></span>6918</td>
<td class="instruction">LD HL,$6961</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at <a href="6961.html">Table_WormCollectionCount</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="691b"></span>691B</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-1" rowspan="1">Add the index to get the table entry address.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="691c"></span>691C</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="3">Write the worm collection count for this level to *<a href="5FB2.html">WormsRemaining</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="691d"></span>691D</td>
<td class="instruction">LD HL,$5FB2</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6920"></span>6920</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="6921"></span>
<div class="comments">
<div class="paragraph">
Reset all collected and disabled worm markers in the room attribute data back to 00.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6921"></span>6921</td>
<td class="instruction">LD HL,$DE9E</td>
<td class="comment-1" rowspan="1">Point <span class="register">HL</span> at <a href="DE9E.html">RoomAttribute_Data</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6924"></span>6924</td>
<td class="instruction">LD BC,$0160</td>
<td class="comment-1" rowspan="1">Set the byte counter to 0160 in <span class="register">BC</span>.</td>
</tr>
<tr>
<td class="asm-label">ResetWorm_Markers_Loop</td>
<td class="address-2"><span id="6927"></span>6927</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="4">If *<span class="register">HL</span> equals 1F (disabled marker), write 00 to *<span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6928"></span>6928</td>
<td class="instruction">CP $1F</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="692a"></span>692A</td>
<td class="instruction">JR NZ,<a href="68F7.html#692e">ResetWorm_TestCollected</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="692c"></span>692C</td>
<td class="instruction">LD (HL),$00</td>
</tr>
<tr>
<td class="asm-label">ResetWorm_TestCollected</td>
<td class="address-2"><span id="692e"></span>692E</td>
<td class="instruction">CP $1E</td>
<td class="comment-1" rowspan="3">If *<span class="register">HL</span> equals 1E (collected marker), write 00 to *<span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6930"></span>6930</td>
<td class="instruction">JR NZ,<a href="68F7.html#6934">ResetWorm_Markers_Next</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6932"></span>6932</td>
<td class="instruction">LD (HL),$00</td>
</tr>
<tr>
<td class="asm-label">ResetWorm_Markers_Next</td>
<td class="address-2"><span id="6934"></span>6934</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Move to the next data byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6935"></span>6935</td>
<td class="instruction">DEC BC</td>
<td class="comment-1" rowspan="1">Decrease the byte counter by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6936"></span>6936</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="3">Jump back to <a href="68F7.html#6927">ResetWorm_Markers_Loop</a> until all 0160 bytes are processed.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6937"></span>6937</td>
<td class="instruction">OR B</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6938"></span>6938</td>
<td class="instruction">JR NZ,<a href="68F7.html#6927">ResetWorm_Markers_Loop</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="693a"></span>693A</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return.</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="68B8.html">68B8</a>
</td>
<td class="up">Up: <a href="../maps/all.html#68f7">Map</a></td>
<td class="next">
Next: <a href="693B.html">693B</a>
</td>
</tr>
</table>
<footer>
<div class="release"></div>
<div class="copyright">&copy; 2026 Urbanscan<br />&copy; 1984 Gremlin Graphics Software Ltd<br />&copy; 2026 ArcadeGeek LTD.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 9.6.</div>
<div class="repository">Link to <a rel="noopener nofollow" href="https://github.com/pobtastic/percythepottypigeon/">Source code</a>.</div>
<div><a href="../dec/asm/26871.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
<title>Percy the Potty Pigeon: Routine at 6480</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-wide.css" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-75RERFCHBG"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-75RERFCHBG');
</script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="6456.html">6456</a>
</td>
<td class="up">Up: <a href="../maps/all.html#6480">Map</a></td>
<td class="next">
Next: <a href="64E7.html">64E7</a>
</td>
</tr>
</table>
<div class="description">6480: Update Energy Bar</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="5FE9.html">MainGameLoop</a>.
</div>
<div class="paragraph">
Animates Percy's energy bar at the bottom of the screen. The bar depletes when Percy is airborne and refills when Percy is on the ground. If the bar fully depletes, Percy enters the falling state.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">UpdateEnergyBar</td>
<td class="address-2"><span id="6480"></span>6480</td>
<td class="instruction">LD HL,$52EC</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=52EC (screen buffer location for the energy bar).</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="6483"></span>
<div class="comments">
<div class="paragraph">
If *<a href="5FA7.html">FallingState</a> is non-zero, it's acting as a cooldown timer so decrement it and return.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6483"></span>6483</td>
<td class="instruction">LD A,($5FA7)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=*<a href="5FA7.html">FallingState</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6486"></span>6486</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="2">Jump to <a href="6480.html#648e">UpdateEnergyBar_CheckPosition</a> if *<a href="5FA7.html">FallingState</a> is zero (Percy isn't falling).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6487"></span>6487</td>
<td class="instruction">JR Z,<a href="6480.html#648e">UpdateEnergyBar_CheckPosition</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6489"></span>6489</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="1">Decrement the cooldown timer.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="648a"></span>648A</td>
<td class="instruction">LD ($5FA7),A</td>
<td class="comment-1" rowspan="1">Write <span class="register">A</span> to *<a href="5FA7.html">FallingState</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="648d"></span>648D</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="648e"></span>
<div class="comments">
<div class="paragraph">
Check if Percy is on the ground (Y &gt;= 90). If so, the energy bar
</div>
<div class="paragraph">
refills. Otherwise it depletes.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">UpdateEnergyBar_CheckPosition</td>
<td class="address-2"><span id="648e"></span>648E</td>
<td class="instruction">LD A,(IX+$01)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with Percy's Y position (from *<span class="register">IX</span>+01).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6491"></span>6491</td>
<td class="instruction">CP $90</td>
<td class="comment-1" rowspan="2">Jump to <a href="6480.html#64be">UpdateEnergyBar_Refill</a> if Percy is at, or below the ground level (90).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6493"></span>6493</td>
<td class="instruction">JR NC,<a href="6480.html#64be">UpdateEnergyBar_Refill</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="6495"></span>
<div class="comments">
<div class="paragraph">
Percy is airborne so deplete the energy bar. Uses a slower frame delay of 07 frames between each step.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6495"></span>6495</td>
<td class="instruction">LD A,($5FAB)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=*<a href="5FAA.html#5fab">5FAB</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6498"></span>6498</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="1">Increment the frame delay counter.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6499"></span>6499</td>
<td class="instruction">LD ($5FAB),A</td>
<td class="comment-1" rowspan="1">Write <span class="register">A</span> back to *<a href="5FAA.html#5fab">5FAB</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="649c"></span>649C</td>
<td class="instruction">CP $07</td>
<td class="comment-1" rowspan="2">Return if it's not yet time to update the energy bar.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="649e"></span>649E</td>
<td class="instruction">RET NZ</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="649f"></span>
<div class="comments">
<div class="paragraph">
Reset the frame counter and check if Percy is on a platform (energy doesn't deplete while landed).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="649f"></span>649F</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="2">Write 00 to *<a href="5FAA.html#5fab">5FAB</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64a0"></span>64A0</td>
<td class="instruction">LD ($5FAB),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64a3"></span>64A3</td>
<td class="instruction">LD A,($5FAD)</td>
<td class="comment-1" rowspan="3">Return if *<a href="5FAD.html">LandedOnPlatformFlag</a> is set, indicating Percy is landed on a platform.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64a6"></span>64A6</td>
<td class="instruction">OR A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64a7"></span>64A7</td>
<td class="instruction">RET NZ</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="64a8"></span>
<div class="comments">
<div class="paragraph">
Deplete the energy bar by shifting pixels left. Scans rightward from the current position to find the rightmost filled byte, then shifts it left by one pixel.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">UpdateEnergyBar_Deplete_FindByte</td>
<td class="address-2"><span id="64a8"></span>64A8</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="3">Jump to <a href="6480.html#64b6">UpdateEnergyBar_Deplete_ScanLeft</a> if *<span class="register">HL</span> is zero (no pixels here).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64a9"></span>64A9</td>
<td class="instruction">OR A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64aa"></span>64AA</td>
<td class="instruction">JR Z,<a href="6480.html#64b6">UpdateEnergyBar_Deplete_ScanLeft</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64ac"></span>64AC</td>
<td class="instruction">SLA (HL)</td>
<td class="comment-1" rowspan="1">Shift *<span class="register">HL</span> left one pixel (remove one pixel of energy).</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="64ae"></span>
<div class="comments">
<div class="paragraph">
Copy the updated byte to the three pixel rows below to give the energy bar its height.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">UpdateEnergyBar_CopyRows</td>
<td class="address-2"><span id="64ae"></span>64AE</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=*<span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64af"></span>64AF</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="2">Copy to the first row below.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64b0"></span>64B0</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64b1"></span>64B1</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="2">Copy to the second row below.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64b2"></span>64B2</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64b3"></span>64B3</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="2">Copy to the third row below.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64b4"></span>64B4</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64b5"></span>64B5</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="64b6"></span>
<div class="comments">
<div class="paragraph">
Current byte is empty so scan leftward for the next filled byte.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">UpdateEnergyBar_Deplete_ScanLeft</td>
<td class="address-2"><span id="64b6"></span>64B6</td>
<td class="instruction">DEC L</td>
<td class="comment-1" rowspan="1">Move one byte to the left.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64b7"></span>64B7</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="3">Jump to <a href="6480.html#64e1">UpdateEnergyBar_Depleted</a> if the energy bar is fully depleted (reached E0 the left edge of the bar).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64b8"></span>64B8</td>
<td class="instruction">CP $E0</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64ba"></span>64BA</td>
<td class="instruction">JR Z,<a href="6480.html#64e1">UpdateEnergyBar_Depleted</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64bc"></span>64BC</td>
<td class="instruction">JR <a href="6480.html#64a8">UpdateEnergyBar_Deplete_FindByte</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="6480.html#64a8">UpdateEnergyBar_Deplete_FindByte</a> to check this byte.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="64be"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="69A7.html">Run_Main_Loop_Body</a>.
</div>
<div class="paragraph">
Percy is on the ground so refill the energy bar. Uses a faster frame delay of 03 frames between each step.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">UpdateEnergyBar_Refill</td>
<td class="address-2"><span id="64be"></span>64BE</td>
<td class="instruction">LD A,($5FAB)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=*<a href="5FAA.html#5fab">5FAB</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64c1"></span>64C1</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="1">Increment the frame delay counter.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64c2"></span>64C2</td>
<td class="instruction">LD ($5FAB),A</td>
<td class="comment-1" rowspan="1">Write <span class="register">A</span> back to *<a href="5FAA.html#5fab">5FAB</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64c5"></span>64C5</td>
<td class="instruction">CP $03</td>
<td class="comment-1" rowspan="2">Return if not yet time to update the bar.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64c7"></span>64C7</td>
<td class="instruction">RET C</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64c8"></span>64C8</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="2">Write 00 to *<a href="5FAA.html#5fab">5FAB</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64c9"></span>64C9</td>
<td class="instruction">LD ($5FAB),A</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="64cc"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="655C.html">Start_Level</a>.
</div>
<div class="paragraph">
Refill the energy bar by shifting pixels right (filling from the left). Scans leftward to find the first non-full byte and fills it one pixel at a time.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">UpdateEnergyBar_Refill_Shift</td>
<td class="address-2"><span id="64cc"></span>64CC</td>
<td class="instruction">LD HL,$52E1</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=52E1 (left edge of the energy bar).</td>
</tr>
<tr>
<td class="asm-label">UpdateEnergyBar_Refill_FindByte</td>
<td class="address-2"><span id="64cf"></span>64CF</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=*<span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64d0"></span>64D0</td>
<td class="instruction">CP $FF</td>
<td class="comment-1" rowspan="2">Jump to <a href="6480.html#64da">UpdateEnergyBar_Refill_ScanRight</a> if this byte is full (scan next byte).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64d2"></span>64D2</td>
<td class="instruction">JR Z,<a href="6480.html#64da">UpdateEnergyBar_Refill_ScanRight</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64d4"></span>64D4</td>
<td class="instruction">SRL (HL)</td>
<td class="comment-1" rowspan="1">Shift *<span class="register">HL</span> right one pixel.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64d6"></span>64D6</td>
<td class="instruction">SET 7,(HL)</td>
<td class="comment-1" rowspan="1">Set bit 7 of *<span class="register">HL</span> (fill from the left).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64d8"></span>64D8</td>
<td class="instruction">JR <a href="6480.html#64ae">UpdateEnergyBar_CopyRows</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="6480.html#64ae">UpdateEnergyBar_CopyRows</a> to copy the result to the rows below.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="64da"></span>
<div class="comments">
<div class="paragraph">
Current byte is fully filled so scan rightward for the next byte to fill.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">UpdateEnergyBar_Refill_ScanRight</td>
<td class="address-2"><span id="64da"></span>64DA</td>
<td class="instruction">INC L</td>
<td class="comment-1" rowspan="1">Move one byte to the right.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64db"></span>64DB</td>
<td class="instruction">LD A,L</td>
<td class="comment-1" rowspan="3">Return if the bar is fully refilled (the scan reached ED which is the right edge of the bar).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64dc"></span>64DC</td>
<td class="instruction">CP $ED</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64de"></span>64DE</td>
<td class="instruction">RET Z</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64df"></span>64DF</td>
<td class="instruction">JR <a href="6480.html#64cf">UpdateEnergyBar_Refill_FindByte</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="6480.html#64cf">UpdateEnergyBar_Refill_FindByte</a> to check this byte.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="64e1"></span>
<div class="comments">
<div class="paragraph">
Energy bar has fully depleted so set Percy to the falling state.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">UpdateEnergyBar_Depleted</td>
<td class="address-2"><span id="64e1"></span>64E1</td>
<td class="instruction">LD A,$FF</td>
<td class="comment-1" rowspan="2">Write FF to *<a href="5FA7.html">FallingState</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64e3"></span>64E3</td>
<td class="instruction">LD ($5FA7),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="64e6"></span>64E6</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return.</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="6456.html">6456</a>
</td>
<td class="up">Up: <a href="../maps/all.html#6480">Map</a></td>
<td class="next">
Next: <a href="64E7.html">64E7</a>
</td>
</tr>
</table>
<footer>
<div class="release"></div>
<div class="copyright">&copy; 2026 Urbanscan<br />&copy; 1984 Gremlin Graphics Software Ltd<br />&copy; 2026 ArcadeGeek LTD.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 9.6.</div>
<div class="repository">Link to <a rel="noopener nofollow" href="https://github.com/pobtastic/percythepottypigeon/">Source code</a>.</div>
<div><a href="../dec/asm/25728.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
<title>Percy the Potty Pigeon: Routine at 28435</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-wide.css" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-75RERFCHBG"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-75RERFCHBG');
</script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="28253.html">28253</a>
</td>
<td class="up">Up: <a href="../maps/all.html#28435">Map</a></td>
<td class="next">
Next: <a href="28500.html">28500</a>
</td>
</tr>
</table>
<div class="description">28435: Initialise Car</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="28253.html">Handler_Car_Type1</a>.
</div>
<div class="paragraph">
Initialises a car with random speed, colour and position. The car starts at Y=144 (upper road) with the possibility of appearing at different X positions.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">IX</td>
<td class="register-desc">Pointer to car sprite data</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="asm-label">InitialiseCar</td>
<td class="address-2"><span id="28435"></span>28435</td>
<td class="instruction">CALL <a href="27705.html">GenerateRandomNumber</a></td>
<td class="comment-1" rowspan="1">Call <a href="27705.html">GenerateRandomNumber</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28438"></span>28438</td>
<td class="instruction">AND %00000011</td>
<td class="comment-1" rowspan="1">Keep only bits 0-1 (random speed 0-3).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28440"></span>28440</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="1">Increment (speed 1-4).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28441"></span>28441</td>
<td class="instruction">LD (29196),A</td>
<td class="comment-1" rowspan="1">Write <span class="register">A</span> to *<a href="29192.html#29196">CarSpeed2</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="28444"></span>
<div class="comments">
<div class="paragraph">
Set a random appearance delay if the room is valid.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28444"></span>28444</td>
<td class="instruction">LD A,(24517)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=*<a href="24517.html">CurrentRoom</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28447"></span>28447</td>
<td class="instruction">OR A</td>
<td class="comment-1" rowspan="2">Jump to <a href="28435.html#28460">InitialiseCar_PickColour</a> if the room number is zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28448"></span>28448</td>
<td class="instruction">JR Z,<a href="28435.html#28460">InitialiseCar_PickColour</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28450"></span>28450</td>
<td class="instruction">CALL <a href="27705.html">GenerateRandomNumber</a></td>
<td class="comment-1" rowspan="1">Call <a href="27705.html">GenerateRandomNumber</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28453"></span>28453</td>
<td class="instruction">AND %00011111</td>
<td class="comment-1" rowspan="1">Keep only bits 0-4.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28455"></span>28455</td>
<td class="instruction">OR %00000001</td>
<td class="comment-1" rowspan="1">Set bit 0 (ensure odd value).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28457"></span>28457</td>
<td class="instruction">LD (29198),A</td>
<td class="comment-1" rowspan="1">Write <span class="register">A</span> to *<a href="29192.html#29198">CarAppearanceDelay</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="28460"></span>
<div class="comments">
<div class="paragraph">
Pick a random colour, but reject colour 1 (blue).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">InitialiseCar_PickColour</td>
<td class="address-2"><span id="28460"></span>28460</td>
<td class="instruction">CALL <a href="27705.html">GenerateRandomNumber</a></td>
<td class="comment-1" rowspan="1">Call <a href="27705.html">GenerateRandomNumber</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28463"></span>28463</td>
<td class="instruction">AND %00000011</td>
<td class="comment-1" rowspan="1">Keep only bits 0-1 (random colour 0-3).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28465"></span>28465</td>
<td class="instruction">CP 1</td>
<td class="comment-1" rowspan="2">Jump to <a href="28435.html#28460">InitialiseCar_PickColour</a> if the colour is BLUE (pick again).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28467"></span>28467</td>
<td class="instruction">JR Z,<a href="28435.html#28460">InitialiseCar_PickColour</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28469"></span>28469</td>
<td class="instruction">LD (29194),A</td>
<td class="comment-1" rowspan="1">Write <span class="register">A</span> to *<a href="29192.html#29194">CarColour</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="28472"></span>
<div class="comments">
<div class="paragraph">
Clear the crash timer and set the car on the upper road.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28472"></span>28472</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="2">Write 0 to *<a href="29192.html">CarCrashTimer</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28473"></span>28473</td>
<td class="instruction">LD (29192),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28476"></span>28476</td>
<td class="instruction">LD (IX+1),144</td>
<td class="comment-1" rowspan="1">Write 144 to *<span class="register">IX</span>+1 (front Y: upper road).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28480"></span>28480</td>
<td class="instruction">LD (IX+5),144</td>
<td class="comment-1" rowspan="1">Write 144 to *<span class="register">IX</span>+5 (rear Y: upper road).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28484"></span>28484</td>
<td class="instruction">LD (IX+34),7</td>
<td class="comment-1" rowspan="1">Write 7 to *<span class="register">IX</span>+34 (front wheel colour: white).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28488"></span>28488</td>
<td class="instruction">LD (IX+38),7</td>
<td class="comment-1" rowspan="1">Write 7 to *<span class="register">IX</span>+38 (rear wheel colour: white).</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="28492"></span>
<div class="comments">
<div class="paragraph">
If the car's X position is past 100 reset it to the left.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28492"></span>28492</td>
<td class="instruction">LD A,(IX+0)</td>
<td class="comment-1" rowspan="1">Load <span class="register">A</span> with the car's X position (from *<span class="register">IX</span>+0).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28495"></span>28495</td>
<td class="instruction">CP 100</td>
<td class="comment-1" rowspan="2">Return if the car's X position is less than 100 (position is valid).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28497"></span>28497</td>
<td class="instruction">RET C</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28498"></span>28498</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=0 (reset X position to the left edge).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="28499"></span>28499</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return.</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="28253.html">28253</a>
</td>
<td class="up">Up: <a href="../maps/all.html#28435">Map</a></td>
<td class="next">
Next: <a href="28500.html">28500</a>
</td>
</tr>
</table>
<footer>
<div class="release"></div>
<div class="copyright">&copy; 2026 Urbanscan<br />&copy; 1984 Gremlin Graphics Software Ltd<br />&copy; 2026 ArcadeGeek LTD.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 9.6.</div>
<div class="repository">Link to <a rel="noopener nofollow" href="https://github.com/pobtastic/percythepottypigeon/">Source code</a>.</div>
<div><a href="../../asm/6F13.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>